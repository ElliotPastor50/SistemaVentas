<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>üßæ Registro de Ventas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                background-color: #121212;
                color: #00ffff;
            }
            .form-control, .form-select {
                background-color: #1f1f1f;
                color: #00ffff;
                border: 1px solid #00ffff;
            }
            .btn {
                margin: 5px;
            }
            .table-dark {
                color: #00ffff;
            }
            th, td {
                vertical-align: middle !important;
            }
            .error-text {
                color: #ff0040;
                font-size: 0.9em;
            }
            .nested-table {
                margin: 0;
                border-collapse: collapse;
            }
            .nested-table th, .nested-table td {
                border: 1px solid #00ffff;
                padding: 3px 6px;
            }
        </style>
    </head>
    <body class="container py-4">

        <h1 class="text-center mb-4">üßæ Registro de Ventas</h1>

        <!-- Formulario de Venta -->
        <div class="card bg-dark mb-4 p-3">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Cliente</label>
                    <input list="clientes" id="clienteInput" class="form-control" placeholder="Selecciona o escribe..." required>
                    <datalist id="clientes"></datalist>
                    <input type="hidden" id="idCliente">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="fechaVenta" class="form-control" required>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="btnAgregarProd" class="btn btn-primary w-100">‚ûï Agregar Producto</button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Productos Din√°micos -->
        <div id="productosContainer"></div>

        <!-- Bot√≥n Registrar Venta -->
        <div class="text-center mb-4">
            <button id="btnRegistrar" class="btn btn-success" disabled>üíæ Registrar Venta</button>
        </div>

        <!-- Tabla Resultado -->
        <h2 class="mb-3">üìã Ventas Registradas</h2>
        <table class="table table-dark table-bordered">
            <thead>
                <tr>
                    <th>ID Venta</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody id="ventasBody">
                <!-- Se completar√° din√°micamente -->
            </tbody>
        </table>

        <script>
            let productos = [];
            let filaCount = 0;

            document.addEventListener('DOMContentLoaded', () => {
                cargarClientes();
                cargarProductos();
                document.getElementById('btnAgregarProd').addEventListener('click', agregarFilaProducto);
                document.getElementById('btnRegistrar').addEventListener('click', registrarVenta);
                cargarVentasExistentes();
            });

            async function cargarClientes() {
                const res = await fetch('cliente');
                const list = await res.json();
                const datalist = document.getElementById('clientes');
                list.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = `${c.nombre} ${c.apellido}`;
                    opt.dataset.id = c.idCliente;
                    datalist.appendChild(opt);
                });
                document.getElementById('clienteInput').addEventListener('input', () => {
                    const val = document.getElementById('clienteInput').value;
                    const match = [...datalist.options].find(o => o.value === val);
                    document.getElementById('idCliente').value = match ? match.dataset.id : '';
                    actualizarBotonRegistrar();
                });
            }

            async function cargarProductos() {
                const res = await fetch('producto');
                productos = await res.json();
            }

            function agregarFilaProducto(e) {
                e.preventDefault();
                filaCount++;
                const cont = document.getElementById('productosContainer');
                const div = document.createElement('div');
                div.className = 'row g-3 mb-3 align-items-end';
                div.id = `fila${filaCount}`;
                div.innerHTML = `
              <div class="col-md-4">
                <label class="form-label">Producto</label>
                <select class="form-select prodSel" data-fila="${filaCount}" required>
                  <option value="">-- Elige producto --</option>
                  ${productos.map(p => `<option value="${p.idProducto}" data-stock="${p.stock}" data-precio="${p.precio}">
                    ${p.nombre} (Stock: ${p.stock})
                  </option>`).join('')}
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Cant.</label>
                <input type="number" class="form-control qtyInp" data-fila="${filaCount}" min="1" required>
                <div class="error-text hidden" id="errStock${filaCount}">¬°Sin stock suficiente!</div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Precio</label>
                <input type="number" class="form-control priceInp" data-fila="${filaCount}" readonly>
              </div>
              <div class="col-md-2">
                <button class="btn btn-danger delBtn" data-fila="${filaCount}">üóëÔ∏è</button>
              </div>
            `;
                cont.appendChild(div);

                // Eventos de fila
                const sel = div.querySelector('.prodSel');
                const qty = div.querySelector('.qtyInp');
                sel.addEventListener('change', () => {
                    const opt = sel.selectedOptions[0];
                    const precio = opt?.dataset.precio || 0;
                    div.querySelector('.priceInp').value = precio;
                    validarFila(filaCount);
                });
                qty.addEventListener('input', () => validarFila(filaCount));
                div.querySelector('.delBtn').addEventListener('click', (ev) => {
                    ev.preventDefault();
                    div.remove();
                    actualizarBotonRegistrar();
                });
                actualizarBotonRegistrar();
            }

            function validarFila(id) {
                const sel = document.querySelector(`.prodSel[data-fila="${id}"]`);
                const qty = document.querySelector(`.qtyInp[data-fila="${id}"]`);
                const err = document.getElementById(`errStock${id}`);
                const stock = +sel.selectedOptions[0]?.dataset.stock || 0;
                if (qty.value > stock) {
                    err.classList.remove('hidden');
                } else {
                    err.classList.add('hidden');
                }
                actualizarBotonRegistrar();
            }

            function actualizarBotonRegistrar() {
                const filas = document.querySelectorAll('#productosContainer .row');
                const tieneFilas = filas.length > 0;
                let valido = tieneFilas;
                filas.forEach(f => {
                    const id = f.id.replace('fila', '');
                    const sel = f.querySelector(`.prodSel[data-fila="${id}"]`);
                    const qty = f.querySelector(`.qtyInp[data-fila="${id}"]`);
                    const stock = +sel.selectedOptions[0]?.dataset.stock || 0;
                    if (!sel.value || !qty.value || qty.value > stock)
                        valido = false;
                });
                // Cliente y fecha
                const cli = document.getElementById('idCliente').value;
                const fecha = document.getElementById('fechaVenta').value;
                if (!cli || !fecha)
                    valido = false;
                document.getElementById('btnRegistrar').disabled = !valido;
            }

            async function registrarVenta() {
                try {
                    // 1) Registro de Venta
                    const idCli = parseInt(document.getElementById('idCliente').value, 10);
                    const fecha = document.getElementById('fechaVenta').value;
                    const payloadV = {idCliente: idCli, fecha};

                    const resV = await fetch('venta', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payloadV)
                    });
                    if (!resV.ok) {
                        const text = await resV.text();
                        throw new Error(`Error /venta: ${resV.status} ${text}`);
                    }
                    const {idVenta} = await resV.json();

                    // 2) Registro de Detalles
                    // Reconstruyo el array para asegurar nombres correctos
                    const filas = document.querySelectorAll('#productosContainer .row');
                    const detallesPayload = Array.from(filas).map(f => {
                        const id = f.id.replace('fila', '');
                        const sel = f.querySelector(`.prodSel[data-fila="${id}"]`);
                        const qty = f.querySelector(`.qtyInp[data-fila="${id}"]`);
                        const price = f.querySelector(`.priceInp[data-fila="${id}"]`);
                        const cantidad = parseInt(qty.value, 10);
                        const detallePrecio = parseFloat(price.value);
                        return {
                            idProducto: parseInt(sel.value, 10),
                            cantProd: cantidad,
                            detallePrecio: detallePrecio,
                            sbttTotal: detallePrecio * cantidad
                        };
                    });

                    const resD = await fetch('detalle', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({idVenta, detalles: detallesPayload})
                    });
                    if (!resD.ok) {
                        const text = await resD.text();
                        throw new Error(`Error /detalle: ${resD.status} ${text}`);
                    }
                    const resultD = await resD.json(); // deber√≠a ser { estado: "ok" }

                    // 3) Mostrar en tabla y limpiar
                    agregarVentaATabla({
                        idVenta,
                        fecha,
                        cliente: document.getElementById('clienteInput').value,
                        detalles: detallesPayload
                    });
                    document.getElementById('productosContainer').innerHTML = '';
                    document.getElementById('btnRegistrar').disabled = true;

                } catch (err) {
                    console.error(err);
                    alert(err.message);
                }
            }

            function agregarVentaATabla( { idVenta, fecha, cliente, detalles }) {
                const tbody = document.getElementById('ventasBody');
                const tr = document.createElement('tr');
                tr.innerHTML = `
              <td>${idVenta}</td>
              <td>${fecha}</td>
              <td>${cliente}</td>
              <td></td>
            `;
                // Mini-tabla de detalles
                const tdDet = tr.querySelector('td:last-child');
                if (detalles.length === 0) {
                    tdDet.textContent = 'No hay detalles';
                } else {
                    const tbl = document.createElement('table');
                    tbl.className = 'nested-table';
                    tbl.innerHTML = `
                <thead>
                  <tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr>
                </thead>
                <tbody>
                  ${detalles.map(d => {
                        const p = productos.find(x => x.idProducto === d.idProducto);
                        return `<tr>
                      <td>${p.nombre}</td>
                      <td>${d.cantProd}</td>
                      <td>${d.sbttTotal.toFixed(2)}</td>
                    </tr>`;
                    }).join('')}
                </tbody>
              `;
                    tdDet.appendChild(tbl);
                }
                tbody.appendChild(tr);
            }

            async function cargarVentasExistentes() {
                const res = await fetch('venta');
                const ventas = await res.json();
                for (const v of ventas) {
                    // Para cada venta, cargar sus detalles
                    const resD = await fetch('detalle');
                    const allDet = await resD.json();
                    const dets = allDet.filter(d => d.idVenta === v.idVenta);
                    agregarVentaATabla({
                        idVenta: v.idVenta,
                        fecha: v.fecha,
                        cliente: v.cliente,
                        detalles: dets.map(d => ({
                                idProducto: d.idProducto,
                                cantProd: d.cantidad,
                                sbttTotal: d.subtotal
                            }))
                    });
                }
            }
        </script>

    </body>
</html>





